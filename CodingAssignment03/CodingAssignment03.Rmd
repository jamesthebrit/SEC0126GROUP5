---
title: "Coding Assignment 3"
author: "Team 5"
date: "Due: 2021-12-09 23:59"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
#Put any packages you need here
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(gtsummary)#used for table summary code
library(jtools)
library(gt)
library(car) #for vif function
library(corrplot) #for Corrplot function
```

A Florida health insurance company wants to predict annual claims for individual clients. The company pulls a random sample of 50 customers. The owner wishes to charge an actuarially fair premium to ensure a normal rate of return. The owner collects all of their current customer’s health care expenses from the last year and compares them with what is known about each customer’s plan. 

The data on the 50 customers in the sample is as follows:

-	Charges: Total medical expenses for a particular insurance plan (in dollars)
-	Age: Age of the primary beneficiary
-	BMI: Primary beneficiary’s body mass index (kg/m2)
-	Female: Primary beneficiary’s birth sex (0 = Male, 1 = Female)
-	Children: Number of children covered by health insurance plan (includes other dependents as well)
-	Smoker: Indicator if primary beneficiary is a smoker (0 = non-smoker, 1 = smoker)
-	Cities: Dummy variables for each city with the default being Sanford

Answer the following questions using complete sentences and attach all output, plots, etc. within this report.


```{r dataset, include=FALSE}
insurance <- read.csv("../Data/insurance_0126_Group5.csv")
```



## Question 1

Randomly select three observations from the sample and exclude from all modeling (i.e. n=47). Provide the summary statistics (min, max, std, mean, median) of the quantitative variables for the 47 observations.

```{r q1}
set.seed(123457)
index <- sample(seq_len(nrow(insurance)), size = 3)
insurance.new <- insurance[-index ,] 
insurance.test <- insurance[index ,]
```

```{r q1.1}
insurance_86dummy <- insurance.new[-c(4,6,7,8,9)]
```


```{r q1.2}
insurance_86dummy[,c(1:3)] %>% #this has the min, max, SD, median, and mean all
  tbl_summary(statistic = list(all_continuous() ~ c("{mean} ({sd})",
                                                    "{median} ({p25}, {p75})",
                                                    "{min}, {max}"),
                              all_categorical() ~ "{n} / {N} ({p}%)"),
              type = all_continuous() ~ "continuous2"
  )
```
*Children Summary Data*
```{r q1.3}
summary(insurance_86dummy$Children)#summary information for children with Sd below
```
*Children Standard Deviation*
```{r q1.3.1}
sd(insurance_86dummy$Children)
```

## Question 2

Provide the correlation between all quantitative variables

```{r q2.1}
corrplot(cor(insurance_86dummy),
        type = "lower",order = "hclust",
        tl.col = "black",
        tl.srt = 45,
        addCoef.col = "black",
        diag = FALSE,)
```


## Question 3

Run a regression that includes all independent variables in the data table. Does the model above violate any of the Gauss-Markov assumptions? If so, what are they and what is the solution for correcting?


```{r q3.1}
model <- lm(Charges ~., data = insurance.new)
summary(model)
```



```{r q3.2, message=FALSE, warning=FALSE}
par(mfrow=c(2,2))
plot(model)
scatterplotMatrix(insurance_86dummy)
```
3rd Assumption - Nonlineraity. Residuals v Fitted. FUNCTIONAL FORMS.
 - Consider using ratios or percentages rather than raw data (see module on multicollinearity for a complete discussion of the associated problems and causes)

6th Assumption - Normal Distribution Is Not In Place. [Normal Q-Q)]
 - look for subgroups in data and analyze separately; use summary data (like the mean value) rather than the raw data
 
4th Assumption - Heteroskedaticity Is Occuring Within Scale-Location


## Question 4

Implement the solutions from question 3, such as data transformation, along with any other changes you wish. Use the sample data and run a new regression. How have the fit measures changed? How have the signs and significance of the coefficients changed?

Model 1 & 2 Against Bad Model

```{r q4 message=FALSE, warning=FALSE}

insurance.new$LogCharges <- log(insurance.new$Charges)
par(mfrow=c(1,2))
hist(insurance.new$Charges, main="Insurance Charges")
hist(insurance.new$LogCharges, main="Log of Insurance Charges")
```
Model Specification Doc 4 . 2
logInsurance
Interaction Trm 4 - 4

```{r q4.1 ,message=FALSE, warning=FALSE}
insurance_LogChg86Dummy <- insurance.new[,c(10,2:3,5)]
scatterplotMatrix(insurance_LogChg86Dummy, main = "Log Charges (No Dummies)")
scatterplotMatrix(insurance_86dummy, main = "Charges (No Dummies)")
```

``` {r q4.2}
model_LogCharges <- lm(LogCharges~., data = insurance.new[,c(10,2:9)])##See if we want to put a summary model here
summary(model_LogCharges)
```

``` {r q4.3, message=FALSE, warning=FALSE}
insurance.new$LogAge <- log(insurance.new$Age)
insurance.new$AgeSq <- insurance.new$Age^2

insurance_LogChrgAgeWDummy <- insurance.new[,c(11,10,3:9)]
insurance_LogChrgAge86Dummy <- insurance.new[,c(10,11,3,5)]
insurance_LogChrgAgeSq86Dummy <- insurance.new[,c(10,12,3,5)]

model_LogChargesNAge <- lm(LogCharges~., data = insurance_LogChrgAgeWDummy)

summary(model_LogChargesNAge)#Model: Age with a logaritmic shape
par(mfrow=c(2,2))
plot(model_LogChargesNAge)
scatterplotMatrix(insurance_LogChrgAge86Dummy, main = "Log Charges and Age (No Dummies)")
scatterplotMatrix(insurance_LogChrgAgeSq86Dummy, main = "Log Charges and Age Sqd (No Dummies)")
```

```{r q4.4}
model_LogChrgAgeSq <- lm(LogCharges ~., data = insurance.new[,c(12,2:10)])
summary(model_LogChrgAgeSq)#Model: Age with a Quadratic Relationship
par(mfrow=c(2,2))
plot(model_LogChrgAgeSq)
```

```{r q4.5, message=FALSE, warning=FALSE}
insurance.new$LogBMI <- log(insurance.new$BMI)
insurance.new$BMISq <- insurance.new$BMI^2

insurance_LogBMIWDummy <- insurance.new[,c(13,2,4:10)]
insurance_LogChrgBMI86Dummy <- insurance.new[,c(2,5,10,13)]
insurance_LogChrgBMISq86Dummy <- insurance.new[,c(2,5,10,14)]


model_LogChrgBMIWDummy <- lm(LogCharges~., data = insurance.new[,c(2,4:10,13)])

summary(model_LogChrgBMIWDummy)#Model: BMI with a logaritmic shape
par(mfrow=c(2,2))
plot(model_LogChrgBMIWDummy)
scatterplotMatrix(insurance_LogChrgBMI86Dummy, main = "Log Charges and BMI (No Dummies)")
scatterplotMatrix(insurance_LogChrgBMISq86Dummy, main = "Log Charges and BMI Sqd (No Dummies")
```

```{r q4.6}
model_LogChrgBMISq <- lm(LogCharges ~., data = insurance.new[,c(2:10,14)])
summary(model_LogChrgBMISq)#Model: Age with a Quadratic Relationship
par(mfrow=c(2,2))
plot(model_LogChrgBMISq)
```

## Question 5

Use the 3 withheld observations and calculate the performance measures for your best two models. Which is the better model? (remember that "better" depends on whether your outlook is short or long run)

```{r q5.1}
insurance.test$LogCharges <- log(insurance.test$Charges)
insurance.test$BMISq <- insurance.test$BMI^2
insurance.test$AgeSq <- insurance.test$Age^2
```

```{r q5.2}
insurance.test$bad_model_pred <- predict(model, newdata = insurance.test)

insurance.test$model_1_pred <- predict(model_LogChrgBMISq,newdata = insurance.test) %>% exp()

insurance.test$model_2_pred <- predict(model_LogChrgAgeSq,newdata = insurance.test) %>% exp()

# Finding the error

insurance.test$error_bm <- insurance.test$bad_model_pred - insurance.test$Charges

insurance.test$error_1 <- insurance.test$model_1_pred - insurance.test$Charges

insurance.test$error_2 <- insurance.test$model_2_pred - insurance.test$Charges
```

bias

```{r q5.3} 
# Bad Model
mean(insurance.test$error_bm)

# Model 1
mean(insurance.test$error_1)

# Model 2
mean(insurance.test$error_2)
```

MAE


```{r}
# I decided to create a function to calculate this

mae <- function(error_vector){
  error_vector %>% 
  abs() %>% 
  mean()
}

# Bad Model
mae(insurance.test$error_bm)

# Model 1
mae(insurance.test$error_1)

# Model 2
mae(insurance.test$error_2)

```

RMSE

```{r}
rmse <- function(error_vector){
   error_vector^2 %>% 
  mean() %>% 
  sqrt()

}

# Bad Model
rmse(insurance.test$error_bm)
# Model 1
rmse(insurance.test$error_1)

# Model 2
rmse(insurance.test$error_2)
```

MAPE

```{r}
mape <- function(error_vector, actual_vector){
  (error_vector/actual_vector) %>% 
    abs() %>% 
    mean()
}

# Bad Model
mape(insurance.test$error_bm, insurance.test$Charges)
# Model 1
mape(insurance.test$error_1, insurance.test$Charges)

# Model 2
mape(insurance.test$error_2, insurance.test$Charges)
```

The initial model performed the worst when compared to the other two. When compared to the other two, the bias, MAE, and MAPE of the logarithmic connection are lower. Since Model 2's RMSE is lower, there were no significant prediction mistakes. Depending on your preferred time frame, you could choose any model. Model 2 is appropriate if you're considering the near future. If you are considering the long term, choose Model 1.


## Question 6

Provide interpretations of the coefficients, do the signs make sense? Perform marginal change analysis (thing 2) on the independent variables.

```{r q6}
#Verbal Based Response
model_LogChrgBMISq <- lm(LogCharges ~., data = insurance.new[,c(2:10,14)])
summary(model_LogChrgBMISq)


##Positive Intercept. Age Increases In A Linear Fashion As Does Charges. As BMI Increases So Does Charges. If Client Is Female Charges Increases Which Makes Sense For Pregnancy Charges. All Locations Help Decreases Charges Unless Default At Sanford.

##Of All SEEx2 Tests - Children Appears To Show The Most Room For Error
```

## Question 7

An eager insurance representative comes back with five potential clients. Using the better of the two models selected above, provide the prediction intervals for the five potential clients using the information provided by the insurance rep.

| Customer | Age | BMI | Female | Children | Smoker | City           |
| -------- | --- | --- | ------ | -------- | ------ | -------------- | 
| 1        | 60  | 22  | 1      | 0        | 0      | Oviedo         |
| 2        | 40  | 30  | 0      | 1        | 0      | Sanford        |
| 3        | 25  | 25  | 0      | 0        | 1      | Winter Park    |
| 4        | 33  | 35  | 1      | 2        | 0      | Winter Springs |
| 5        | 45  | 27  | 1      | 3        | 0      | Oviedo         |


```{r q7}
#Find Models And Run Indexed Variables
model_LogChrgBMISq

Clients <- data.frame(
  Age = c(60, 40, 25, 33, 45),
  BMI = c(22,30,25,35,27),
  BMISq = c(22^2),(30^2),(25^2),(35^2),(27^2),
  Female = c(1,0,0,1,1),
  Children = c(0,1,0,2,3),
  Smoker = c(0,0,1,0,0),
  WinterSprings = c(0,0,0,1,0),
  WinterPark = c(0,0,1,0,0),
  Oviedo = c(1,0,0,0,1)
  )
predict(model_LogChrgBMISq, newdata = Clients,interval = "prediction")
```

## Question 8

The owner notices that some of the predictions are wider than others, explain why.

Reference Questions 1& 2

Verbal Response
## Question 9 

Are there any prediction problems that occur with the five potential clients? If so, explain.
Verbal Response
Reference Questions 1& 2